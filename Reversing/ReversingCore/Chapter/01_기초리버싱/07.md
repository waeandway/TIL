### **07 스택 프레임 [실습](https://waeandway.tistory.com/entry/%EB%A6%AC%EB%B2%84%EC%8B%B1%ED%95%B5%EC%8B%AC%EC%9B%90%EB%A6%AC-%EC%8A%A4%ED%83%9D%ED%94%84%EB%A0%88%EC%9E%84-%EB%B6%84%EC%84%9D?category=1057355)**

- **스택 프레임** <br>
EBP를 사용해 스택 내의 로컬 변수, 파라미터, 복귀 주소에 접근하는 기법. 어떤 기준 시점(함수 시작)의 ESP값을 EBP값에 저장하고 이를 함수 내에서 유지해주면, ESP값이 아무리 변해도 EBP를 기준으로 안전하게 해당 함수의 변수, 파라미터, 복귀주소에 접근할 수 있다.

- <span style="color:red"> **스택 프레임의 구조** </span>  <br>

어셈블리|내용
:---|:---
**PUSH EBP**|함수 시작 (EBP를 사용하기 전, 기존의 값을 스택에 저장)
**MOV EBP, ESP**|현재의 ESP를 EBP에 저장
**...**|함수 본체 <br> 여기서 ESP가 변경되더라도 EBP가 변경되지 않으므로 안전하게 로컬변수와 파라미터에  접근 가능
**MOV ESP, EBP**|ESP를 정리 (함수 시작했을 떄의 값으로 복원시킴)
**POP EBP**|리턴되기 전에 저장해 놓았던 원래 EBP값으로 복원
**RETN**|함수 종료


<span style="color:gray">

> *최신 컴파일러는 최적화 옵션을 갖고 있어, 간단한 함수 같은 경우 스택프레임을 생성하지 않는다.*

> *스택에 복귀주소가 저장된다는 점이 보안 취약점으로 작용할 수 있다. buffer overflow 기법을 사용해 복귀주소가 저장된 스택 메모리를 의도적으로 다른 값으로 변경할 수 있다.*

</span>
<br>

- **실습 예제 - stackframe.exe**

```
// StackFrame.cpp

#include "stdio.h"

long add(long a, long b)
{
	long x = a, y = b;
	return (x + y);
}
int main(int argc, char* argv[])
{
	long a = 1, b = 2;
	printf("%d\n", add(a, b));
	return 0;
}
```

- <span style="color:red"> **스택 프레임의 원리** </span>  <br>

<div style="text-align:center">
<img src="../../../img/Stackframe.png" width="500">
</div>

**1) 스택 프레임 생성 (=EBP 세팅)**

- 특정 함수를 CALL하기 전, 함수의 실행이 끝난 후 돌아갈 리턴 주소(*Retrun Address*)는 ESP에 저장되고 스택에 PUSH된다. (by OS)
- 스택 프레임이 생성된다(=EBP가 세팅된다). `MOV EBP,ESP` 명령어를 통해 함수가 끝날 때까지 EBP 값이 고정되며, 스택에 저장된 함수 파라미터와 로컬변수들은 EBP를 통해 접근할 수 있는 것이다.

**2) 로컬 변수 세팅**

- `SUB ESP,8` 함수의 로컬변수는 스택에 저장된다. 위 코드의 로컬변수 'a', 'b'는 long타입이므로 각각 4바이트 크기를 가지고, 이 두 변수를 스택에 저장하기 위해 총 8바이트가 필요하다. 
- 이제 EBP를 기준으로 삼아 로컬변수에 액세스할 수 있다.

Assembly|Comment
:---|:---
**MOV DWORD PTR SS:[EBP-4],1**|[EBP-4] = local 'a'
**MOV DWORD PTR SS:[EBP-8],2**|[EBP-8] = local 'b'


※ *어셈블리와 C언어의 포인터 구문 형식*

Assembly|C|Type casting
:---|:---|:---
DWORD PTR SS:[EBP-4]|* (DWORD*)(EBP-4)|DWORD (4byte)
WORD PTR SS:[EBP-4]|* (WORD*)(EBP-4)|WORD (2byte)
BYTE PTR SS:[EBP-4]|* (BYTE*)(EBP-4)|byte

**3) add()함수 파라미터 입력, add()함수 호출**

StackFrame.cpp에서 `printf("%d\n", add(a, b));`에 해당되는 내용이다.

Assembly|Comment
:---|:---
MOV EAX, DWORD PTR SS:[EBP-8]|[EBP-8] = b
PUSH EAX|Arg2 = 00000002
MOV ECX, DWORD PTR SS:[EBP-4]|[EBP-4] = a
PUSH ECX|Arg1 = 00000001
CALL 004010000|add( )

주목할 점은 C언어의 입력순서와는 반대로 <span style="color:red">파라미터는 역순</span>으로 저장된다는 것이다.